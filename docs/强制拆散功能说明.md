# 强制拆散功能说明 (Force Split Feature)

## 🎯 问题背景

### Bertalign的"强制对齐偏差"

Bertalign使用动态规划算法寻找全局最优对齐方案，导致以下问题：

1. **高基线相似度**: LaBSE模型即使对完全不相关的句子，相似度也在0.3-0.4之间
2. **累加效应**: 算法为了避免"跳过惩罚"，会强行对齐不相关的句子
3. **向量平均掩盖**: N:M对齐时，相关句子的高相似度会拉高平均值，掩盖不相关句子

### 示例

**原文**: "Machine learning algorithms require large datasets."
**译文**: 
- T1: "机器学习算法需要大量数据集。" (相关，相似度≈0.95)
- T2: "今天天气很好，适合出去散步。" (完全不相关)

**Bertalign行为**: 将S1对齐到T1+T2 (1:2对齐)
**向量平均相似度**: 0.72 (被T1拉高)
**实际问题**: T2应该被识别为"增添"

---

## 💡 解决方案

### 1. 最小相似度策略 (`use_min_similarity=True`)

**原理**: 对N:M对齐，计算所有源-目标句子对的相似度，取**最小值**

**效果**:
```
S1 vs T1: 0.95
S1 vs T2: 0.35  ← 最小值
最终相似度: 0.35 (而非平均值0.72)
```

**代码**:
```python
qa_tool = TranslationQA(
    use_min_similarity=True  # 默认True
)
```

### 2. 强制拆散阈值 (`force_split_threshold=0.5`)

**原理**: 在Step 3中，检查每个对齐组的相似度，如果低于严格阈值（默认0.5），强制拆散为缺失+增添

**逻辑**:
```python
if similarity < force_split_threshold:
    # 拆散为缺失
    for src_idx in src_indices:
        omissions.append(src_idx)
    # 拆散为增添
    for tgt_idx in tgt_indices:
        additions.append(tgt_idx)
```

**代码**:
```python
qa_tool = TranslationQA(
    force_split_threshold=0.5  # 默认0.5，可调整
)
```

---

## 📊 测试结果

### 测试用例

**原文** (5句):
```
S0: The quantum processor operates at near-zero temperatures.
S1: Machine learning algorithms require large datasets.
S2: Blockchain technology ensures data integrity.
S3: Cloud computing provides scalable infrastructure.
S4: Cybersecurity is critical for protecting sensitive information.
```

**译文** (7句):
```
T0: 量子处理器在接近零度的温度下运行。
T1: 机器学习算法需要大量数据集。
T2: 今天天气很好，适合出去散步。  ← 不相关
T3: 区块链技术确保数据完整性。
T4: 云计算提供可扩展的基础设施。
T5: 网络安全对于保护敏感信息至关重要。
T6: 这是一句额外增加的话，原文中没有对应内容。  ← 不相关
```

### 结果对比

| 策略 | 对齐2 (S1 vs T1+T2) | 对齐5 (S4 vs T5+T6) | 检测结果 |
|------|---------------------|---------------------|----------|
| **向量平均** | 相似度: 0.72 | 相似度: 0.71 | ❌ 未检测到增添 |
| **最小相似度** | 相似度: 0.35 | 相似度: 0.32 | ✅ 检测到4处增添 |

### 最终CSV报告

```csv
原文,译文,源索引,目标索引,相似度,异常情况
...,量子处理器在接近零度的温度下运行。,0,0,0.9055,OK
Machine learning algorithms...,,1,,,缺失 (Omission)
...,区块链技术确保数据完整性。,2,3,0.8586,OK
...,云计算提供可扩展的基础设施。,3,4,0.9285,OK
Cybersecurity...,,4,,,缺失 (Omission)
,机器学习算法需要大量数据集。,,1,,增添 (Addition)
,今天天气很好，适合出去散步。,,2,,增添 (Addition)
,网络安全对于保护敏感信息至关重要。,,5,,增添 (Addition)
,这是一句额外增加的话...,,6,,增添 (Addition)
```

✅ **T2和T6被正确识别为增添！**

---

## 🔧 参数调优建议

### `force_split_threshold` (默认0.5)

| 阈值 | 效果 | 适用场景 |
|------|------|----------|
| 0.3 | 极严格，可能误拆 | 要求极高质量的翻译 |
| **0.5** | **推荐** | 平衡准确性和召回率 |
| 0.6 | 较宽松 | 允许一定程度的意译 |

### `use_min_similarity` (默认True)

| 设置 | 效果 | 适用场景 |
|------|------|----------|
| **True** | **推荐** | 检测N:M对齐中的不相关句子 |
| False | 使用向量平均 | 传统方法，可能漏检 |

---

## ✅ 总结

### 核心改进

1. ✅ **最小相似度策略**: 避免向量平均掩盖不相关句子
2. ✅ **强制拆散机制**: 将低相似度对齐组拆散为缺失+增添
3. ✅ **去重逻辑**: 避免重复添加缺失/增添

### 实际效果

| 异常类型 | 检测方式 | 效果 |
|---------|---------|------|
| 缺失 (Omission) | 强制拆散 | ✅ 有效 |
| 增添 (Addition) | 强制拆散 | ✅ 有效 |
| 相似度低 | 阈值检测 | ✅ 有效 |

### 使用建议

**推荐配置**:
```python
qa_tool = TranslationQA(
    similarity_threshold=0.7,      # 相似度低阈值
    force_split_threshold=0.5,     # 强制拆散阈值
    use_min_similarity=True        # 使用最小相似度
)
```

**查看报告时**:
- ✅ 关注"缺失"和"增添"，检查是否合理
- ✅ 关注"相似度低"，检查是否为意译或错译
- ✅ 关注"强制拆散对齐组"数量，评估阈值是否合适

