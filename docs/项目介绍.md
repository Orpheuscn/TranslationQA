# 语义对齐 - 翻译质量检查工具

## 项目背景

### 问题

在翻译工作中，译者和审校人员经常需要对照原文和译文，检查翻译质量。传统的检查方式存在以下问题：

1. **手动对齐效率低**: 需要人工逐句对照原文和译文，耗时耗力
2. **难以发现遗漏和增添**: 当原文和译文句子数量不一致时，很难快速定位缺失或多余的内容
3. **缺乏量化指标**: 难以客观评估翻译的语义准确性
4. **复杂对齐难以处理**: 当一句原文对应多句译文（或反之）时，手动对齐容易出错

### 解决方案

本项目开发了一个基于深度学习的翻译质量检查工具，能够：

1. **自动句子对齐**: 使用 Bertalign + LaBSE 自动对齐原文和译文句子
2. **支持 N:M 对齐**: 智能处理一对多、多对一、多对多的句子对齐
3. **语义相似度计算**: 使用 LaBSE 计算句子对的语义相似度，量化翻译质量
4. **异常检测**: 自动检测缺失 (Omission)、增添 (Addition)、相似度低等翻译问题
5. **词对齐**: 点击句子对可以查看词级别的对齐和相似度
6. **多语言支持**: 支持 100+ 种语言，包括拉丁语、古希腊语等古典语言

---

## 核心技术

### 1. Bertalign - 句子对齐算法

**技术**: 基于 BERT 的双语句子对齐算法

**原理**:
- 使用 LaBSE 将源语言和目标语言的句子编码为语义向量
- 使用动态规划搜索最佳对齐路径
- 支持 1:1、1:N、N:1、N:M 等复杂对齐模式

**优势**:
- 跨语言语义理解能力强
- 支持 100+ 种语言
- 能处理句子顺序变化、合并、拆分等复杂情况

**论文**: [Bertalign: A Multilingual Sentence Alignment Tool](https://aclanthology.org/2022.acl-demo.26/)

---

### 2. LaBSE - 语言无关的句子嵌入

**技术**: Language-agnostic BERT Sentence Embeddings

**原理**:
- 使用 BERT 模型将句子编码为 768 维向量
- 跨语言的句子如果语义相似，向量也相似
- 使用余弦相似度计算句子对的语义相似度

**优势**:
- 支持 109 种语言
- 跨语言语义对齐能力强
- 可以用于句子级和词级的语义相似度计算

**论文**: [Language-agnostic BERT Sentence Embedding](https://arxiv.org/abs/2007.01852)

**实现**: 使用 ONNX 版本，避免 macOS ARM64 平台的兼容性问题

---

### 3. fastText - 语言检测

**技术**: Facebook 的快速文本分类库

**原理**:
- 使用字符级 n-gram 特征
- 快速准确地检测文本语言

**优势**:
- 支持 170+ 种语言
- 速度快，准确率高
- 可以处理短文本和混合语言文本

---

### 4. 多语言分句

**技术**: 结合 HanLP、spaCy、正则表达式的多语言分句器

**支持语言**:
- **中文**: HanLP 规则分句器
- **日语**: HanLP 规则分句器
- **韩语**: spaCy `ko_core_news_sm` 模型
- **拉丁语**: spaCy 自定义规则
- **其他语言**: spaCy 多语言模型 + 正则表达式

**优势**:
- 针对不同语言使用最佳分句策略
- 支持古典语言（拉丁语、古希腊语等）
- 准确率高

---

## 核心功能

### 功能 1: 句子对齐

**描述**: 自动对齐原文和译文的句子

**输入**:
- 原文 (Source Text)
- 译文 (Target Text)

**输出**:
- CSV 格式的对齐结果表格
- 每行包含：原文、译文、源索引、目标索引、相似度、异常情况

**支持的对齐模式**:
- **1:1 对齐**: 一句原文对应一句译文
- **1:N 对齐**: 一句原文对应多句译文
- **N:1 对齐**: 多句原文对应一句译文
- **N:M 对齐**: 多句原文对应多句译文

**示例**:

| 原文 (Source) | 译文 (Target) | 源索引 | 目标索引 | 相似度 | 异常情况 |
|--------------|--------------|--------|---------|--------|---------|
| Hello, world! | 你好，世界！ | 0 | 0 | 0.92 | OK |
| How are you? | 你好吗？ | 1 | 1 | 0.88 | OK |
| I am fine. | 我很好。 | 2 | 2 | 0.85 | OK |
| Thank you. | 谢谢你。 | 3 | 3 | 0.90 | OK |

---

### 功能 2: 语义相似度计算

**描述**: 计算每个句子对的语义相似度

**方法**:
- 使用 LaBSE 编码源句子和目标句子
- 计算余弦相似度 (Cosine Similarity)
- 对于 N:M 对齐，可选择使用最小相似度（更严格）

**相似度范围**: 0.0 - 1.0
- **0.9 - 1.0**: 语义几乎完全一致
- **0.8 - 0.9**: 语义高度相似
- **0.7 - 0.8**: 语义相似
- **0.6 - 0.7**: 语义部分相似
- **< 0.6**: 语义差异较大

**应用**:
- 标记"相似度低"的句子对
- 量化翻译质量
- 辅助人工审校

---

### 功能 3: 翻译异常检测

**描述**: 自动检测翻译中的常见问题

**检测类型**:

#### 3.1 缺失 (Omission)
- **定义**: 原文中的句子在译文中没有对应
- **标记**: 红色背景
- **原因**: 译者遗漏、故意删减、对齐失败

#### 3.2 增添 (Addition)
- **定义**: 译文中的句子在原文中没有对应
- **标记**: 橙色背景
- **原因**: 译者添加、注释、对齐失败

#### 3.3 相似度低 (Low Similarity)
- **定义**: 句子对的语义相似度低于阈值
- **标记**: 黄色背景
- **原因**: 翻译不准确、改写过度、术语翻译错误

**检测逻辑**:
1. 如果对齐组的相似度 < `force_split_threshold`，强制拆散为缺失+增添
2. 如果对齐组的相似度 < `similarity_threshold`，标记为"相似度低"
3. 如果源句子没有对应的目标句子，标记为"缺失"
4. 如果目标句子没有对应的源句子，标记为"增添"

---

### 功能 4: 词对齐

**描述**: 点击句子对旁边的"词对齐"按钮，展开词级别的对齐

**输入**:
- 对齐组的源句子（可能是多句合并）
- 对齐组的目标句子（可能是多句合并）

**输出**:
- CSV 格式的词对齐表格
- 每行包含：源词、目标词、源索引、目标索引、相似度

**方法**:
1. **分词**: 使用 HanLP (中文)、spaCy (其他语言)、正则表达式 (fallback)
2. **编码**: 使用 LaBSE 编码每个词
3. **对齐**: 使用贪心算法，为每个源词找到最相似的目标词
4. **过滤**: 过滤掉相似度过低的对齐

**示例**:

原文: "Hello, world!"  
译文: "你好，世界！"

| 源词 | 目标词 | 源索引 | 目标索引 | 相似度 |
|------|--------|--------|---------|--------|
| Hello | 你好 | 0 | 0 | 0.85 |
| world | 世界 | 1 | 1 | 0.88 |

---

### 功能 5: 多语言支持

**支持的语言**: 100+ 种

**特别支持的语言**:
- **古典语言**: 拉丁语 (Latin)、古希腊语 (Ancient Greek)
- **东亚语言**: 中文、日语、韩语
- **欧洲语言**: 英语、法语、德语、西班牙语、意大利语、俄语等
- **其他语言**: 阿拉伯语、印地语、土耳其语等

**语言检测**: 使用 fastText 自动检测源语言和目标语言

**分句支持**: 针对不同语言使用最佳分句策略

---

### 功能 6: 可调参数

**描述**: 提供丰富的参数设置，适应不同的翻译场景

**参数分类**:
1. **质量检测参数**: 相似度阈值、强制拆散阈值
2. **Bertalign 对齐参数**: 最大对齐数、Top-K、跳过惩罚、窗口大小、分数阈值
3. **高级功能**: 使用最小相似度、自动拆散 N:M 对齐

**详细说明**: 参见 [参数说明文档](参数说明.md)

---

## 使用场景

### 场景 1: 技术文档翻译审校

**需求**:
- 检查翻译是否完整（无缺失、无增添）
- 检查术语翻译是否准确
- 量化翻译质量

**推荐配置**: 直译式翻译配置
- `similarity_threshold = 0.7`
- `force_split_threshold = 0.5`
- `auto_split_nm = True`

---

### 场景 2: 文学作品翻译审校

**需求**:
- 允许改写和创意翻译
- 检查语义是否保留
- 处理大量 N:M 对齐

**推荐配置**: 改写式翻译配置
- `similarity_threshold = 0.6`
- `force_split_threshold = 0.4`
- `auto_split_nm = False`

---

### 场景 3: 翻译记忆库对齐

**需求**:
- 将历史翻译对齐成句子对
- 构建翻译记忆库 (TM)
- 用于机器翻译训练

**推荐配置**: 高质量对齐配置
- `max_align = 8`
- `top_k = 5`
- `skip = -1.5`

---

### 场景 4: 翻译质量评估

**需求**:
- 量化翻译质量
- 生成质量报告
- 比较不同译者的翻译

**推荐配置**: 默认配置
- 使用相似度作为质量指标
- 统计缺失、增添、相似度低的数量

---

## 技术架构

### 后端

**框架**: Flask  
**语言**: Python 3.12  
**主要依赖**:
- `bertalign`: 句子对齐
- `onnxruntime`: LaBSE ONNX 推理
- `fasttext`: 语言检测
- `hanlp`: 中文/日文分句和分词
- `spacy`: 多语言分句和分词
- `numpy`: 数值计算

**API 端点**:
- `POST /check`: 翻译质量检查
- `POST /word_align`: 词对齐

---

### 前端

**技术**: 原生 HTML + CSS + JavaScript  
**特点**:
- 响应式设计
- 可折叠的高级设置面板
- 可展开的词对齐表格
- 颜色编码的异常标记

---

### 部署

**开发环境**:
```bash
python -m venv venv
source venv/bin/activate  # macOS/Linux
pip install -r requirements.txt
python app.py
```

**生产环境**:
- 使用 Gunicorn 或 uWSGI
- 配置 Nginx 反向代理
- 使用 Docker 容器化部署

---

## 项目特色

### 1. 支持古典语言

本项目特别支持拉丁语、古希腊语等古典语言，填补了现有翻译工具的空白。

**实现**:
- 手动添加拉丁语到 Bertalign 的语言字典
- 使用 spaCy 自定义分句规则
- LaBSE 模型原生支持拉丁语

---

### 2. 智能 N:M 对齐处理

**问题**: Bertalign 可能产生不合理的 N:N 对齐（例如，两个独立的 1:1 对齐被错误合并成 2:2）

**解决方案**: 自动拆散 N:M 对齐功能
- 检测 N:N 对齐（N==M 且 N>1）
- 计算拆散后的 1:1 相似度
- 如果平均 1:1 相似度更高，自动拆散

---

### 3. 词对齐功能

**创新点**: 点击句子对即可查看词级别的对齐

**应用**:
- 检查术语翻译
- 学习翻译技巧
- 构建词典

---

### 4. 灵活的参数配置

**特点**: 提供 9 个可调参数，适应不同翻译场景

**预设配置**:
- 直译式翻译
- 改写式翻译
- 高质量对齐
- 快速对齐

---

## 未来规划

### 短期目标

1. **批量处理**: 支持上传文件批量处理
2. **导出功能**: 导出 CSV、Excel、TMX 格式
3. **可视化**: 添加对齐可视化图表
4. **统计报告**: 生成详细的质量统计报告

### 长期目标

1. **机器翻译集成**: 集成 Google Translate、DeepL 等 MT 引擎
2. **术语库**: 支持自定义术语库
3. **协同审校**: 多人协同审校功能
4. **API 服务**: 提供 RESTful API 供第三方调用

---

## 许可证

MIT License

---

## 致谢

本项目使用了以下开源项目：

- [Bertalign](https://github.com/bfsujason/bertalign) - 句子对齐算法
- [LaBSE](https://tfhub.dev/google/LaBSE/2) - 语言无关的句子嵌入
- [fastText](https://fasttext.cc/) - 语言检测
- [HanLP](https://github.com/hankcs/HanLP) - 中文自然语言处理
- [spaCy](https://spacy.io/) - 多语言自然语言处理

感谢这些优秀的开源项目！

