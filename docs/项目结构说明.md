# 项目结构说明

## 📁 目录结构

```
语义对齐/
├── 核心模块
│   ├── translation_qa_tool.py      # 翻译质量检查核心工具
│   ├── labse_onnx_encoder.py       # LaBSE ONNX编码器
│   └── text_splitter.py            # 文本分句模块
│
├── Web服务
│   ├── app.py                      # Flask服务器
│   ├── templates/
│   │   └── index.html              # 网页界面
│   └── static/
│       ├── style.css               # 样式文件
│       └── script.js               # 前端脚本
│
├── 模型文件
│   └── labse_onnx/                 # LaBSE ONNX模型
│       ├── model.onnx              # ONNX模型文件
│       ├── config.json             # 模型配置
│       ├── tokenizer.json          # 分词器
│       └── vocab.txt               # 词汇表
│
├── 文档
│   ├── WEB_README.md               # Web版使用说明
│   ├── README.md                   # 主文档
│   ├── 项目结构说明.md             # 本文件
│   └── docs/                       # 详细文档
│       ├── Bertalign行为说明.md
│       ├── 强制拆散功能说明.md
│       ├── 性能分析报告.md
│       └── ...
│
├── 配置文件
│   ├── requirements.txt            # Python依赖
│   ├── start_server.sh             # 启动脚本
│   └── test_api.sh                 # API测试脚本
│
└── 虚拟环境
    └── venv/                       # Python虚拟环境
```

---

## 🔧 核心模块说明

### 1. translation_qa_tool.py

**功能**: 翻译质量检查核心工具

**主要类**:
- `TranslationQA`: 主类，提供翻译质量检查功能

**主要方法**:
- `check_translation()`: 执行翻译质量检查
- `save_report_json()`: 保存JSON格式报告
- `save_report_csv()`: 保存CSV格式报告
- `print_summary()`: 打印摘要信息

**关键参数**:
- `similarity_threshold`: 相似度阈值（默认0.7）
- `force_split_threshold`: 强制拆散阈值（默认0.5）
- `use_min_similarity`: 使用最小相似度策略（默认True）
- `max_align`: Bertalign最大对齐数（默认6）

### 2. labse_onnx_encoder.py

**功能**: LaBSE ONNX编码器，替代Bertalign的默认encoder

**主要类**:
- `LaBSEOnnxEncoder`: ONNX编码器

**主要方法**:
- `encode_sentences()`: 编码句子列表为嵌入向量
- `num_layers()`: 返回模型层数

**特点**:
- 使用ONNX Runtime，避免PyTorch在macOS ARM64上的崩溃
- 自动使用脚本所在目录下的`labse_onnx/`模型
- 兼容Bertalign的Encoder接口

### 3. text_splitter.py

**功能**: 文本分句模块

**主要类**:
- `TextSplitter`: 文本分句器

**支持的分句方式**:
- 简单规则分句（默认）
- spaCy分句（英文）
- HanLP分句（中文）

---

## 🌐 Web服务说明

### 1. app.py

**功能**: Flask Web服务器

**主要路由**:
- `GET /`: 主页
- `POST /api/check`: 翻译质量检查API
- `GET /api/health`: 健康检查API

**特点**:
- 全局复用QA工具实例，提高性能
- 支持CORS跨域请求
- 详细的错误处理和日志

### 2. templates/index.html

**功能**: 网页界面

**主要功能**:
- 输入原文和译文
- 调整参数（相似度阈值、强制拆散阈值）
- 显示检测结果（统计信息、CSV表格）
- 下载CSV报告
- 复制表格到剪贴板

### 3. static/style.css

**功能**: 网页样式

**设计特点**:
- 渐变背景
- 响应式布局
- 颜色编码（绿色=OK，黄色=警告，红色=错误）
- 平滑动画效果

### 4. static/script.js

**功能**: 前端交互逻辑

**主要功能**:
- 发送API请求
- 解析CSV数据
- 渲染表格
- 下载和复制功能

---

## 📊 数据流程

```
用户输入
  ↓
网页界面 (index.html)
  ↓
JavaScript (script.js)
  ↓
POST /api/check
  ↓
Flask服务器 (app.py)
  ↓
TranslationQA.check_translation()
  ↓
├─ TextSplitter.split() → 分句
├─ Bertalign.align_sents() → 对齐
│   └─ LaBSEOnnxEncoder.encode_sentences() → 编码
└─ 计算相似度 → 检测异常
  ↓
生成CSV报告
  ↓
返回JSON响应
  ↓
JavaScript渲染结果
  ↓
用户查看/下载
```

---

## 🔑 关键技术

### 1. 句子对齐

- **算法**: Bertalign (基于动态规划)
- **编码模型**: LaBSE (Language-agnostic BERT Sentence Embedding)
- **运行时**: ONNX Runtime (避免PyTorch崩溃)

### 2. 异常检测

- **缺失检测**: 强制拆散低相似度对齐组
- **增添检测**: 强制拆散低相似度对齐组
- **相似度低检测**: 阈值比较

### 3. 性能优化

- **模型复用**: 全局单例，避免重复加载
- **最小相似度策略**: 避免向量平均掩盖不相关句子
- **批量编码**: 一次编码多个句子

---

## 📝 配置文件说明

### requirements.txt

核心依赖：
- `numpy`: 数值计算
- `onnx`: ONNX模型支持
- `onnxruntime`: ONNX运行时
- `bertalign`: 句子对齐
- `transformers`: 分词器
- `flask`: Web框架
- `flask-cors`: CORS支持

### start_server.sh

启动脚本，自动：
1. 检查虚拟环境
2. 激活虚拟环境
3. 安装依赖
4. 启动Flask服务器

---

## 🚀 快速开始

1. **安装依赖**:
   ```bash
   pip install -r requirements.txt
   ```

2. **启动服务器**:
   ```bash
   ./start_server.sh
   ```

3. **访问网页**:
   ```
   http://localhost:5001
   ```

---

## 📄 相关文档

- **WEB_README.md**: Web版详细使用说明
- **README.md**: 主文档
- **docs/强制拆散功能说明.md**: 强制拆散功能详解
- **docs/Bertalign行为说明.md**: Bertalign对齐行为说明
- **docs/性能分析报告.md**: 性能分析和优化建议

